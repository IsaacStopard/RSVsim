---
title: "Calibration"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Calibration}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  cache = TRUE
)
```

```{r setup}
library(RSVsim)
library(ggplot2)
library(patchwork)
```

In this vignette, we give an overview of how to use an Approximate Bayesian Computation (ABC) rejection algorithm to calibrate the mathematical model of RSV transmission to simulated data. First, we run the model and calculate some summary statistics from the model output. Specifically, we calculate the age-specific peak time of incidence infections, the amplitude of incidence (difference between maximum and minimum incidence) and the total yearly incidence. RSVsim has built in functions to calculate these metrics from the model output. We define a function summary_fun to combine these metrics. We will use these as the target for the ABC-rejection algorithm.

```{r simulated_data, dependson="setup"}

# specify age categories to run the model with
age.limits <- c(seq(0, 2, 0.2), seq(10, 60, 5))

# get contact matrix
contact_population_list <- RSVsim_contact_matrix(country = "United Kingdom", age.limits = age.limits)

# get the default model parameters with a b0 value of 0.08 and b1 value of 0
parameters <- RSVsim_parameters(overrides = list("b0" = 0.08, "b1" = 0),
                                contact_population_list = contact_population_list,
                                fitted = NULL)

nAges <- length(age.limits)

out <- RSVsim_run_model(parameters = parameters,
                        times = seq(0, 365*5, 0.25), # maximum time to run the model for
                        cohort_step_size = 0.2*365, # time at which to age people\
                        init_conds = NULL,
                        warm_up = 365*4)


fitted_parameter_names <- c("b0")

fixed_parameter_list <- RSVsim_fixed_parameters(fitted_parameter_names = fitted_parameter_names,
                                                data = unique(out[,c("age_chr", "age")]),
                                                overrides = list("b1" = 0))

summary_fun <- function(out){
  return(c(RSVsim_total_incidence(out), RSVsim_amplitude(out), RSVsim_peak(out)))
}

target <- summary_fun(out)

```

To implement the ABC-rejection algorithm we must specify the tolerance; we specify a specific tolerance for each metric that is approximately 15% of the simulated value. We must also specify a function the randomly samples from the prior distributions of all fitted parameters and returns a vector of the parameters. In this example we fit a single parameter b0. A vector of the parameter names that are being fitted in the same order as the prior samples must also be provided to set up the parameters to run the model.

```{r run_ABC, dependson="simulated_data"}

prior_fun <- function(){

  x <- runif(1, 0.05, 0.15)

  return(x)
}

dist_fun <- function(target, target_star, n = nAges){
  return(
    c(
      RSVsim_abs_dist_fun(target[1:n], target_star[1:n]),
      RSVsim_abs_dist_fun(target[(n+1):(n*2)], target_star[(n+1):(n*2)]),
      RSVsim_shortest_periodic_dist_fun(target[(2*n+1):(n*3)], target_star[(2*n+1):(n*3)], period = 365.25)
    )
  )

}
target_e <- round(target, 2)

epsilon <- c(pmax(100, target[1:nAges] * 0.15), pmax(0.02, target[(nAges+1):(nAges*2)] * 0.15), pmax(50, target[(2*nAges+1):(3*nAges)] * 0.15))

fit <- RSVsim_ABC_rejection(target = target,
                            epsilon = epsilon,
                            summary_fun = summary_fun,
                            dist_fun = dist_fun,
                            prior_fun = prior_fun,
                            nparticles = 1000,
                            ncores = 8,
                            fitted_parameter_names = fitted_parameter_names,
                            fixed_parameter_list = fixed_parameter_list,
                            times = seq(0, 365*5, 0.25), # maximum time to run the model for
                            cohort_step_size = 0.2*365, # time at which to age people\
                            init_conds = NULL,
                            warm_up = 365 * 4)
```

We can then plot the posterior distribution.

```{r abc_plots, dependson="run_ABC"}
hist(fit)

```
