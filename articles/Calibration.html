<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Calibration • RSVsim</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calibration">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RSVsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Calibration.html">Calibration</a></li>
    <li><a class="dropdown-item" href="../articles/Introduction.html">Introduction</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/IsaacStopard/RSVsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Calibration</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/IsaacStopard/RSVsim/blob/master/vignettes/Calibration.Rmd" class="external-link"><code>vignettes/Calibration.Rmd</code></a></small>
      <div class="d-none name"><code>Calibration.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/IsaacStopard/RSVsim" class="external-link">RSVsim</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span></code></pre></div>
<p>In this vignette, we give an overview of how to use an Approximate
Bayesian Computation (ABC) rejection algorithm to calibrate the
mathematical model of RSV transmission to simulated data. The code to
run these samplers was adapted from code provided in Minter, Amanda, and
Renata Retkute. “Approximate Bayesian Computation for infectious disease
modelling.” Epidemics 29 (2019): 100368 <a href="https://doi.org/10.1016/j.epidem.2019.100368" class="external-link uri">https://doi.org/10.1016/j.epidem.2019.100368</a>.</p>
<p>First, we run the model to generate some data to fit to.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># specify age categories to run the model with</span></span>
<span><span class="va">age.limits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0.2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">60</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get contact matrix</span></span>
<span><span class="va">contact_population_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RSVsim_contact_matrix.html">RSVsim_contact_matrix</a></span><span class="op">(</span>country <span class="op">=</span> <span class="st">"United Kingdom"</span>, age.limits <span class="op">=</span> <span class="va">age.limits</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in RSVsim_contact_matrix(country = "United Kingdom", age.limits = age.limits): Not all age.limits are integers.</span></span>
<span><span class="co">#&gt;             The contact matrix was calculated for the age groups given by the integers</span></span>
<span><span class="co">#&gt;             and divided uniformly within the smaller age groups.</span></span>
<span><span class="co">#&gt;             A warning from socialmixr about linearly estimating the integer age groups within the 5-year age bands will also appear.</span></span>
<span><span class="co">#&gt; Warning in pop_age(survey.pop, part.age.group.present, ...): Not all age groups represented in population data (5-year age band).</span></span>
<span><span class="co">#&gt;   Linearly estimating age group sizes from the 5-year bands.</span></span>
<span></span>
<span><span class="co"># get the default model parameters with a b0 value of 0.08 and b1 value of 0</span></span>
<span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RSVsim_parameters.html">RSVsim_parameters</a></span><span class="op">(</span>overrides <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"b0"</span> <span class="op">=</span> <span class="fl">0.08</span>, <span class="st">"b1"</span> <span class="op">=</span> <span class="fl">0.1</span>, <span class="st">"phi"</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                                contact_population_list <span class="op">=</span> <span class="va">contact_population_list</span>,</span>
<span>                                fitted <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nAges</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">age.limits</span><span class="op">)</span></span>
<span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RSVsim_run_model.html">RSVsim_run_model</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span>,</span>
<span>                        times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">365</span><span class="op">*</span><span class="fl">5</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="co"># maximum time to run the model for</span></span>
<span>                        cohort_step_size <span class="op">=</span> <span class="fl">0.2</span><span class="op">*</span><span class="fl">365</span>, <span class="co"># time at which to age people\</span></span>
<span>                        init_conds <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                        warm_up <span class="op">=</span> <span class="fl">365</span><span class="op">*</span><span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fitted_parameter_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b0"</span>, <span class="st">"b1"</span>, <span class="st">"phi"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fixed_parameter_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RSVsim_parameters.html">RSVsim_parameters</a></span><span class="op">(</span>contact_population_list <span class="op">=</span> <span class="va">contact_population_list</span>,</span>
<span>                                          fitted_parameter_names <span class="op">=</span> <span class="va">fitted_parameter_names</span><span class="op">)</span></span></code></pre></div>
<p>Next, we calculate some summary statistics from the model output.
Specifically, we calculate the age-specific peak time of incidence
infections, the amplitude of incidence (difference between maximum and
minimum incidence) and the total yearly incidence. RSVsim has built in
functions to calculate these metrics from the model output. We define a
function summary_fun to combine these metrics. We will use these as the
target for the ABC-rejection algorithm. To implement the ABC-rejection
algorithm we must specify the tolerance; we specify a specific tolerance
for each metric that is approximately 15% of the simulated value. We
must also specify a function the randomly samples from the prior
distributions of all fitted parameters and returns a vector of the
parameters. We use latin hypercube sampling to efficiently sample the
prior space. In this example we fit the b0 and b1 parameters. A vector
of the parameter names that are being fitted in the same order as the
prior samples must also be provided to set up the parameters to run the
model.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#########################</span></span>
<span><span class="co">##### ABC functions #####</span></span>
<span><span class="co">#########################</span></span>
<span></span>
<span><span class="co"># calculate the summary statistics</span></span>
<span><span class="va">summary_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/RSVsim_total_incidence.html">RSVsim_total_incidence</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>, <span class="fu"><a href="../reference/RSVsim_amplitude.html">RSVsim_amplitude</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>, <span class="fu"><a href="../reference/RSVsim_peak.html">RSVsim_peak</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu">summary_fun</span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># a function that samples from the priors is required</span></span>
<span><span class="co"># we use latin hypercube sampling to efficiently sample from the prior distributions</span></span>
<span><span class="va">prior_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_prior_attempts</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">lhs</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lhs/man/randomLHS.html" class="external-link">randomLHS</a></span><span class="op">(</span><span class="va">n_prior_attempts</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># adjusting the prior distributions</span></span>
<span>  <span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">qunif</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, min <span class="op">=</span> <span class="fl">0.05</span>, <span class="fl">0.25</span><span class="op">)</span></span>
<span>  <span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">qunif</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># not necessary but added for completeness</span></span>
<span>  <span class="va">x</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">qunif</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">365.25</span><span class="op">/</span><span class="fl">2</span>, max <span class="op">=</span> <span class="fl">365.25</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># a function that calculates the distance between the summary statistics is required</span></span>
<span><span class="va">dist_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target</span>, <span class="va">target_star</span>, <span class="va">n</span> <span class="op">=</span> <span class="va">nAges</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/RSVsim_abs_dist_fun.html">RSVsim_abs_dist_fun</a></span><span class="op">(</span><span class="va">target</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span>, <span class="va">target_star</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/RSVsim_abs_dist_fun.html">RSVsim_abs_dist_fun</a></span><span class="op">(</span><span class="va">target</span><span class="op">[</span><span class="op">(</span><span class="va">n</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>, <span class="va">target_star</span><span class="op">[</span><span class="op">(</span><span class="va">n</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/RSVsim_shortest_periodic_dist_fun.html">RSVsim_shortest_periodic_dist_fun</a></span><span class="op">(</span><span class="va">target</span><span class="op">[</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">n</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="fl">3</span><span class="op">)</span><span class="op">]</span>, <span class="va">target_star</span><span class="op">[</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">n</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="fl">3</span><span class="op">)</span><span class="op">]</span>, period <span class="op">=</span> <span class="fl">365.25</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#################################</span></span>
<span><span class="co">##### setting the tolerance #####</span></span>
<span><span class="co">#################################</span></span>
<span><span class="co"># calculating a tolerance that means at least 1 particle combination is accepted every 1000 simulation</span></span>
<span><span class="co"># getting 1000 samples from the priors</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">prior_params</span> <span class="op">&lt;-</span> <span class="fu">prior_fun</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulating the summary statistics for each particle</span></span>
<span><span class="va">prior_distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">parameters_in</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">prior_params</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>, <span class="va">fitted_parameter_names</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     <span class="va">fixed_parameter_list</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RSVsim_run_model.html">RSVsim_run_model</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters_in</span>,</span>
<span>                   times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">365</span><span class="op">*</span><span class="fl">5</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="co"># maximum time to run the model for</span></span>
<span>                   cohort_step_size <span class="op">=</span> <span class="fl">0.2</span><span class="op">*</span><span class="fl">365</span>, <span class="co"># time at which to age people\</span></span>
<span>                   init_conds <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                   warm_up <span class="op">=</span> <span class="fl">365</span><span class="op">*</span><span class="fl">4</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">dist_fun</span><span class="op">(</span><span class="va">target</span>, <span class="fu">summary_fun</span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculating the number of particles for which all summary statistics are within the tolerance given different percentiles of the summary statistics </span></span>
<span><span class="va">nsuccess</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">1</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">epsilon_check</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">prior_distances</span>, <span class="fl">1</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">q</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">nsuccess</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">prior_distances</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="va">epsilon_check</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># selecting a tolerance where at least 1 particle is accepted for the 1000 simulations</span></span>
<span><span class="va">epsilon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">prior_distances</span>, <span class="fl">1</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">q</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">nsuccess</span> <span class="op">&gt;=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">###############################################</span></span>
<span><span class="co">##### running the ABC-rejection algorithm #####</span></span>
<span><span class="co">###############################################</span></span>
<span></span>
<span><span class="va">nparticles</span> <span class="op">=</span> <span class="fl">80</span></span>
<span></span>
<span><span class="va">used_seeds_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">nparticles</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RSVsim_ABC_rejection.html">RSVsim_ABC_rejection</a></span><span class="op">(</span>target <span class="op">=</span> <span class="va">target</span>,</span>
<span>                            epsilon <span class="op">=</span> <span class="va">epsilon</span>,</span>
<span>                            summary_fun <span class="op">=</span> <span class="va">summary_fun</span>,</span>
<span>                            dist_fun <span class="op">=</span> <span class="va">dist_fun</span>,</span>
<span>                            prior_fun <span class="op">=</span> <span class="va">prior_fun</span>,</span>
<span>                            n_prior_attempts <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>                            nparticles <span class="op">=</span> <span class="va">nparticles</span>,</span>
<span>                            used_seeds_all <span class="op">=</span> <span class="va">used_seeds_all</span>,</span>
<span>                            ncores <span class="op">=</span> <span class="fl">8</span>,</span>
<span>                            fitted_parameter_names <span class="op">=</span> <span class="va">fitted_parameter_names</span>,</span>
<span>                            fixed_parameter_list <span class="op">=</span> <span class="va">fixed_parameter_list</span>,</span>
<span>                            times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">365</span><span class="op">*</span><span class="fl">5</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="co"># maximum time to run the model for</span></span>
<span>                            cohort_step_size <span class="op">=</span> <span class="fl">0.2</span><span class="op">*</span><span class="fl">365</span>, <span class="co"># time at which to age people\</span></span>
<span>                            init_conds <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                            warm_up <span class="op">=</span> <span class="fl">365</span> <span class="op">*</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p>We can then plot the posterior distribution.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">'b0'</span> <span class="op">=</span> <span class="va">fit</span><span class="op">[</span>,<span class="st">'b0'</span><span class="op">]</span>, <span class="st">'b1'</span> <span class="op">=</span> <span class="va">fit</span><span class="op">[</span>,<span class="st">'b1'</span><span class="op">]</span>, <span class="st">'phi'</span> <span class="op">=</span> <span class="va">fit</span><span class="op">[</span>,<span class="st">'phi'</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b0"</span>, <span class="st">"b1"</span>, <span class="st">"phi"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span>, scales <span class="op">=</span> <span class="st">"free"</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="Calibration_files/figure-html/abc_plots-1.png" width="700"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">fit</span><span class="op">[</span>,<span class="st">'b0'</span><span class="op">]</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       2.5%        50%      97.5% </span></span>
<span><span class="co">#&gt; 0.05368404 0.08147523 0.10458740</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">fit</span><span class="op">[</span>,<span class="st">'b1'</span><span class="op">]</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;        2.5%         50%       97.5% </span></span>
<span><span class="co">#&gt; 0.008292952 0.154739980 0.414731968</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">fit</span><span class="op">[</span>,<span class="st">'phi'</span><span class="op">]</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       2.5%        50%      97.5% </span></span>
<span><span class="co">#&gt; -47.266727   7.129349  62.568962</span></span></code></pre></div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Isaac Stopard, Alexandra Hogan.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
