<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Calibration • RSVsim</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calibration">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RSVsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Calibration.html">Calibration</a></li>
    <li><a class="dropdown-item" href="../articles/Introduction.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/Vaccination.html">Vaccination</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/IsaacStopard/RSVsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Calibration</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/IsaacStopard/RSVsim/blob/master/vignettes/Calibration.Rmd" class="external-link"><code>vignettes/Calibration.Rmd</code></a></small>
      <div class="d-none name"><code>Calibration.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/IsaacStopard/RSVsim" class="external-link">RSVsim</a></span><span class="op">)</span></span></code></pre></div>
<p>In this vignette, we give an overview of how to use Approximate
Bayesian Computation (ABC) rejection and Sequential Monte Carlo ABC
algorithm (ABC-SMC) algorithms to calibrate the mathematical model of
RSV transmission to simulated data. The code to run these samplers was
adapted from code provided in Minter, Amanda, and Renata Retkute.
“Approximate Bayesian Computation for infectious disease modelling.”
Epidemics 29 (2019): 100368 <a href="https://doi.org/10.1016/j.epidem.2019.100368" class="external-link uri">https://doi.org/10.1016/j.epidem.2019.100368</a>.</p>
<p>First, we run the model to generate some data to fit to.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># specify age categories to run the model with</span></span>
<span><span class="va">age_limits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0.2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">60</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get contact matrix</span></span>
<span><span class="va">contact_population_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RSVsim_contact_matrix.html">RSVsim_contact_matrix</a></span><span class="op">(</span>country <span class="op">=</span> <span class="st">"United Kingdom"</span>, age_limits <span class="op">=</span> <span class="va">age_limits</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get the default model parameters with a b0 value of 0.08, b1 value of 0, phi value of 0 and change the initial conditions </span></span>
<span><span class="va">overrides</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"b0"</span> <span class="op">=</span> <span class="fl">0.11</span>, <span class="st">"b1"</span> <span class="op">=</span> <span class="fl">0.3</span>, <span class="st">"phi"</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="va">fixed_parameter_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RSVsim_parameters.html">RSVsim_parameters</a></span><span class="op">(</span>overrides <span class="op">=</span> <span class="va">overrides</span>, </span>
<span>                                                        contact_population_list <span class="op">=</span> <span class="va">contact_population_list</span><span class="op">)</span></span>
<span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RSVsim_run_model.html">RSVsim_run_model</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span>,</span>
<span>                        times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">365</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="co"># maximum time to run the model for</span></span>
<span>                        cohort_step_size <span class="op">=</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="fl">365</span>, <span class="co"># time at which to age people\</span></span>
<span>                        warm_up <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fitted_parameter_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b0"</span>, <span class="st">"b1"</span>, <span class="st">"phi"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nAges</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">[[</span><span class="st">"nAges"</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>Next, we define a function to calculate some summary statistics from
the model output. Specifically, we calculate the age-specific peak time
of incidence infections, the amplitude of incidence (difference between
maximum and minimum incidence) and the total yearly incidence. RSVsim
has built in functions to calculate these metrics from the model output.
We define a function <code>summary_fun</code> to combine these metrics.
We will use these as the target for the ABC-rejection algorithm. We must
also specify a function that randomly samples from the prior
distributions of all fitted parameters and returns a vector of the
parameters. We use latin hypercube sampling to efficiently sample the
prior space. In this example we fit the <code>b0</code>, <code>b1</code>
and <code>phi</code> parameters. A vector of the parameter names that
are being fitted in the same order as the prior samples must also be
provided to set up the parameters to run the model.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#########################</span></span>
<span><span class="co">##### ABC functions #####</span></span>
<span><span class="co">#########################</span></span>
<span></span>
<span><span class="co"># calculate the summary statistics</span></span>
<span><span class="va">summary_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/RSVsim_total_incidence.html">RSVsim_total_incidence</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>, <span class="fu"><a href="../reference/RSVsim_amplitude.html">RSVsim_amplitude</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>, <span class="fu"><a href="../reference/RSVsim_peak.html">RSVsim_peak</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu">summary_fun</span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># a function that samples from the priors is required</span></span>
<span><span class="co"># we use latin hypercube sampling to efficiently sample from the prior distributions</span></span>
<span><span class="va">prior_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_prior_attempts</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">lhs</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lhs/man/randomLHS.html" class="external-link">randomLHS</a></span><span class="op">(</span><span class="va">n_prior_attempts</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># adjusting the prior distributions</span></span>
<span>  <span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">qunif</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, min <span class="op">=</span> <span class="fl">0.05</span>, max <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span>  <span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">qunif</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># not necessary but added for completeness</span></span>
<span>  <span class="va">x</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">qunif</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">365.25</span><span class="op">/</span><span class="fl">2</span>, max <span class="op">=</span> <span class="fl">365.25</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">x</span>, nrow <span class="op">=</span> <span class="va">n_prior_attempts</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># a function that calculates the distance between the summary statistics is required</span></span>
<span><span class="va">dist_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target</span>, <span class="va">target_star</span>, <span class="va">n</span> <span class="op">=</span> <span class="va">nAges</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/RSVsim_abs_dist_fun.html">RSVsim_abs_dist_fun</a></span><span class="op">(</span><span class="va">target</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span>, <span class="va">target_star</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/RSVsim_abs_dist_fun.html">RSVsim_abs_dist_fun</a></span><span class="op">(</span><span class="va">target</span><span class="op">[</span><span class="op">(</span><span class="va">n</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>, <span class="va">target_star</span><span class="op">[</span><span class="op">(</span><span class="va">n</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/RSVsim_shortest_periodic_dist_fun.html">RSVsim_shortest_periodic_dist_fun</a></span><span class="op">(</span><span class="va">target</span><span class="op">[</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">n</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="fl">3</span><span class="op">)</span><span class="op">]</span>, <span class="va">target_star</span><span class="op">[</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">n</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="fl">3</span><span class="op">)</span><span class="op">]</span>, period <span class="op">=</span> <span class="fl">365.25</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>To implement the ABC-rejection algorithm we must specify the
tolerance. We specify a specific tolerance for each metric. To calculate
the tolerance values that means approximately 0.1% of all simulations
are accepted we run the model 1000 times with different parameter
combinations drawn from the priors. We then calculate the error
(distances) between the summary statistics from each simulation and the
target summary statistics. We set the a range of tolerances using
different percentiles of the distances and check the number of these
simulations that are accepted for each tolerance, and use the smallest
tolerance with at least 1 simulation accepted. <strong>This method of
calculating suitable tolerance values is optional and custom values can
be specified by the user.</strong></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#################################</span></span>
<span><span class="co">##### setting the tolerance #####</span></span>
<span><span class="co">#################################</span></span>
<span></span>
<span><span class="co"># this code is optional but is used to approximate epsilon values that will give us an acceptance rate of 0.1%</span></span>
<span></span>
<span><span class="co"># calculating a tolerances that means at least 1 particle combination is accepted every 1000 simulations</span></span>
<span><span class="co"># getting 1000 samples from the priors</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">n_check</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">prior_params</span> <span class="op">&lt;-</span> <span class="fu">prior_fun</span><span class="op">(</span><span class="va">n_check</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulating the summary statistics for each particle combination</span></span>
<span><span class="va">prior_distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_check</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">parameters_in</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RSVsim_update_parameters.html">RSVsim_update_parameters</a></span><span class="op">(</span><span class="va">fixed_parameter_list</span>, <span class="va">fitted_parameter_names</span>, <span class="va">prior_params</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RSVsim_run_model.html">RSVsim_run_model</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters_in</span>,</span>
<span>                   times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">365</span><span class="op">*</span><span class="fl">1</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="co"># maximum time to run the model for</span></span>
<span>                   cohort_step_size <span class="op">=</span> <span class="fl">0.2</span><span class="op">*</span><span class="fl">365</span>, <span class="co"># time at which to age people</span></span>
<span>                   warm_up <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">dist_fun</span><span class="op">(</span><span class="va">target</span>, </span>
<span>                  <span class="fu">summary_fun</span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>                  <span class="op">)</span></span>
<span>         <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculating the number of particles for which all summary statistics are within the tolerance given different percentiles of the summary statistics for all the particles </span></span>
<span><span class="co"># selecting the tolerance with at least 1 model simulation using the prior samples that is within the tolerance </span></span>
<span><span class="va">nsuccess</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">n_check</span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">1</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">epsilon_check</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">prior_distances</span>, <span class="fl">1</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">q</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">nsuccess</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">prior_distances</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="va">epsilon_check</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># selecting a tolerance where at least 1 particle is accepted for the 1000 simulations</span></span>
<span><span class="va">epsilon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">prior_distances</span>, <span class="fl">1</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">q</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">nsuccess</span> <span class="op">&gt;=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>To run the model we specify the number of particles to fit, and the
seeds for each particle. The number of cores can also be specified - if
greater than one then parallel processing is implemented using a
parallel socket cluster with the parallel R package.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">###############################################</span></span>
<span><span class="co">##### running the ABC-rejection algorithm #####</span></span>
<span><span class="co">###############################################</span></span>
<span></span>
<span><span class="va">nparticles</span> <span class="op">=</span> <span class="fl">500</span></span>
<span></span>
<span><span class="va">used_seeds_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">nparticles</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ncores</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RSVsim_ABC_rejection.html">RSVsim_ABC_rejection</a></span><span class="op">(</span>target <span class="op">=</span> <span class="va">target</span>,</span>
<span>                            epsilon <span class="op">=</span> <span class="va">epsilon</span>,</span>
<span>                            summary_fun <span class="op">=</span> <span class="va">summary_fun</span>,</span>
<span>                            dist_fun <span class="op">=</span> <span class="va">dist_fun</span>,</span>
<span>                            prior_fun <span class="op">=</span> <span class="va">prior_fun</span>,</span>
<span>                            n_prior_attempts <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>                            nparticles <span class="op">=</span> <span class="va">nparticles</span>,</span>
<span>                            used_seeds_all <span class="op">=</span> <span class="va">used_seeds_all</span>,</span>
<span>                            ncores <span class="op">=</span> <span class="va">ncores</span>,</span>
<span>                            fitted_parameter_names <span class="op">=</span> <span class="va">fitted_parameter_names</span>,</span>
<span>                            fixed_parameter_list <span class="op">=</span> <span class="va">fixed_parameter_list</span>,</span>
<span>                            times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">365</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="co"># maximum time to run the model for</span></span>
<span>                            cohort_step_size <span class="op">=</span> <span class="fl">0.2</span><span class="op">*</span><span class="fl">365</span>, <span class="co"># time at which to age people\</span></span>
<span>                            warm_up <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># to visualise the posterior distributions</span></span>
<span><span class="va">fit_b0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">fit</span><span class="op">[</span>,<span class="st">"b0"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">fit_b1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">fit</span><span class="op">[</span>,<span class="st">"b1"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">fit_phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">fit</span><span class="op">[</span>,<span class="st">"phi"</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">fit_b0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">fit_b1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">fit_phi</span><span class="op">)</span></span></code></pre></div>
<p>We also provide a function to fit the model using ABC-SMC. The
ABC-SMC algorithm requires a function to return the prior density and a
sequential reduction in the tolerances.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># function that returns the prior likelihood of each parameter (prior density function)</span></span>
<span><span class="co"># returns a vector of the same length as the number of parameters</span></span>
<span><span class="va">prior_dens_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># adjusting the prior distributions</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, min <span class="op">=</span> <span class="fl">0.05</span>, max <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">365.25</span><span class="op">/</span><span class="fl">2</span>, max <span class="op">=</span> <span class="fl">365.25</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span>           <span class="op">)</span></span>
<span>         <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Similar to the ABC-rejection algorithm we use the previously
simulated summary statistics to calculate the tolerances corresponding
to a given number of particle combinations that are accepted. We do this
for a decreasing acceptance rate; the sequential reduction in tolerances
is stored in a matrix with each column corresponding to each summary
statistic and the rows corresponding to each tolerance level
(<code>G</code>; generation). <strong>Again, this method of calculating
suitable tolerance values is optional and custom values can be specified
by the user.</strong></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nsuccess</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">n_check</span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">n_check</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">/</span><span class="va">n_check</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_check</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">epsilon_check</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">prior_distances</span>, <span class="fl">1</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">q</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="va">nsuccess</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_check</span>, <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">prior_distances</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="va">epsilon_check</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">acceptance_rate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span>, <span class="fl">50</span>, <span class="fl">75</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">q_percentile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">acceptance_rate</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">q_percentile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">acceptance_rate</span>, <span class="kw">function</span><span class="op">(</span><span class="va">ar</span><span class="op">)</span><span class="op">{</span><span class="va">q</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">nsuccess</span><span class="op">/</span><span class="va">n_check</span> <span class="op">*</span> <span class="fl">100</span> <span class="op">&gt;</span> <span class="va">ar</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">}</span><span class="op">)</span> <span class="co"># 1</span></span>
<span></span>
<span><span class="va">q_percentile_ar1</span> <span class="op">&lt;-</span> <span class="va">q_percentile</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">acceptance_rate</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># selecting a tolerance where at least 1 particle is accepted for the 1000 simulations</span></span>
<span><span class="va">epsilon_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">q_percentile</span>, <span class="kw">function</span><span class="op">(</span><span class="va">q</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">prior_distances</span>, <span class="fl">1</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="va">q</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">G</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">epsilon_matrix</span><span class="op">)</span></span></code></pre></div>
<p>We can then run the ABC-SMC using the code below. The function also
requires: (1) a matrix of random seeds for each generation and accepted
particle (<code>used_seed_matrix</code>), (2) the minimum and maximum
values for each fitted parameter used in the prior distributions
(<code>particle_low</code> and <code>particle_up</code> respectively),
(3) the number of accepted particles for each generation
(<code>nparticles</code>), (4) the number of prior samples to try for
each accepted particle combination (<code>n_prior_attempts</code>), (5)
the names of the fitted parameters (<code>fitted_parameter_names</code>,
these must be characters and can include indexing into parameters that
are stored as vectors or matrices), (6) a list of all parameters
equivalent to those used in <code>RSVsim_run_model</code>
<code>parameters</code> (<code>fixed_parameter_list</code>) and (7) the
times and cohort step sizes used in <code>RSVsim_run_model</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">used_seed_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">nparticles</span> <span class="op">*</span> <span class="va">G</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">G</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_smc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RSVsim_ABC_SMC.html">RSVsim_ABC_SMC</a></span><span class="op">(</span>target <span class="op">=</span> <span class="va">target</span>,</span>
<span>                          epsilon_matrix <span class="op">=</span> <span class="va">epsilon_matrix</span>,</span>
<span>                          summary_fun <span class="op">=</span> <span class="va">summary_fun</span>,</span>
<span>                          dist_fun <span class="op">=</span> <span class="va">dist_fun</span>,</span>
<span>                          prior_fun <span class="op">=</span> <span class="va">prior_fun</span>,</span>
<span>                          n_prior_attempts <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>                          used_seed_matrix <span class="op">=</span> <span class="va">used_seed_matrix</span>,</span>
<span>                          prior_dens_fun <span class="op">=</span> <span class="va">prior_dens_fun</span>,</span>
<span>                          particle_low <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">365.25</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                          particle_up <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">1</span>, <span class="fl">365.25</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                          nparticles <span class="op">=</span> <span class="va">nparticles</span>,</span>
<span>                          ncores <span class="op">=</span> <span class="va">ncores</span>,</span>
<span>                          fitted_parameter_names <span class="op">=</span> <span class="va">fitted_parameter_names</span>,</span>
<span>                          fixed_parameter_list <span class="op">=</span> <span class="va">fixed_parameter_list</span>,</span>
<span>                          times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">365</span>, <span class="fl">0.25</span><span class="op">)</span>, <span class="co"># maximum time to run the model for</span></span>
<span>                          cohort_step_size <span class="op">=</span> <span class="fl">0.2</span><span class="op">*</span><span class="fl">365</span>, <span class="co"># time at which to age people</span></span>
<span>                          warm_up <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p><strong>Running the model with the fitted parameters.</strong> The
ABC algorithms return matrices of the fitted parameter values. For this
is the main output and for a list of the fitted parameter values is
returned for each generation. The fitted parameter columns correspond to
the parameter and the rows correspond to each accepted parameter
combination. To run the model with one particle (combination of fitted
parameters) we can therefore select the correct matrix of fitted
parameters and use the to adjust the parameters. For example, if I want
to run the <em>first</em> accepted particle:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># ABC rejection</span></span>
<span><span class="va">parameters_ABC_rejection</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RSVsim_update_parameters.html">RSVsim_update_parameters</a></span><span class="op">(</span><span class="va">parameters</span>, <span class="va">fitted_parameter_names</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fit</span><span class="op">[</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b0"</span>, <span class="st">"b1"</span>, <span class="st">"phi"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ABC SMC</span></span>
<span><span class="co"># for the ABC SMC algorithm I must select the fitted parameters from the last generation</span></span>
<span></span>
<span><span class="va">fit_params_SMC</span> <span class="op">&lt;-</span> <span class="va">fit_smc</span><span class="op">$</span><span class="va">fitted_parameters</span><span class="op">[[</span><span class="va">G</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">fit_params_SMC</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">fitted_parameter_names</span></span>
<span></span>
<span><span class="va">parameters_ABC_SMC</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RSVsim_update_parameters.html">RSVsim_update_parameters</a></span><span class="op">(</span><span class="va">parameters</span>, <span class="va">fitted_parameter_names</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fit_params_SMC</span><span class="op">[</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b0"</span>, <span class="st">"b1"</span>, <span class="st">"phi"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Isaac Stopard, Alexandra Hogan.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
